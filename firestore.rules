
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      // Safely attempt to get the user document
      // This path must be exactly /databases/{database}/documents/users/{uid}
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userHasRole(role) {
      let userDoc = getUserDoc();
      // Ensure the document exists AND has data AND the role field matches
      return isSignedIn() &&
             userDoc.exists &&
             userDoc.data != null && // Explicit check for data presence
             userDoc.data.role == role;
    }

    function isCustomer() {
      return userHasRole('customer');
    }

    function isAgency() {
      return userHasRole('agency');
    }

    function isAdmin() {
      return userHasRole('admin');
    }

    // Users Collection (/users/{userId})
    match /users/{userId} {
      // Create: Any authenticated user can create their own profile document during registration.
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Read:
      // - Users can read their own profile.
      // - Admins can read any user's profile.
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Update:
      // - Users can update their own profile (e.g., displayName, but not role directly).
      // - Admins can update any user's profile (e.g., to change a role).
      allow update: if isSignedIn() &&
                      ( (request.auth.uid == userId && !('role' in request.resource.data)) || isAdmin() );
                      // Prevents self-role change unless admin

      // Delete: Generally false for users. Admins could delete.
      allow delete: if isAdmin();
    }

    // Bookings Collection (/bookings/{bookingId})
    match /bookings/{bookingId} {
      // Create:
      // - Customers can create their own bookings.
      // - Agencies can create bookings (e.g., on behalf of customers).
      // - Admins can create bookings.
      allow create: if (isCustomer() && request.resource.data.customerId == request.auth.uid) ||
                       isAgency() ||
                       isAdmin();
      // Read:
      // - Customers can read their own bookings.
      // - Agencies can read all bookings (for a single-agency setup, or needs agencyId filter for multi-agency).
      // - Admins can read all bookings.
      allow read: if (isCustomer() && resource.data.customerId == request.auth.uid) ||
                     isAgency() ||
                     isAdmin();
      // Update:
      // - Agencies can update any booking.
      // - Admins can update any booking.
      allow update: if isAgency() || isAdmin();

      // Delete:
      // - Agencies can delete bookings.
      // - Admins can delete bookings.
      allow delete: if isAgency() || isAdmin();
    }

    // Employees Collection (/employees/{employeeId}) - Primarily Agency data
    match /employees/{employeeId} {
      allow read, write: if isAgency() || isAdmin();
    }

    // Vehicles Collection (/vehicles/{vehicleId}) - Primarily Agency data
    match /vehicles/{vehicleId} {
      allow read, write: if isAgency() || isAdmin();
    }

    // Notifications Collection (/notifications/{notificationId})
    match /notifications/{notificationId} {
      allow create: if isAdmin(); // Or specific agency/system logic

      allow read: if (isCustomer() && resource.data.userId == request.auth.uid && resource.data.role == 'customer') ||
                     (isAgency() && resource.data.role == 'agency') || // Assumes general agency notifications don't have a specific agency userId
                     isAdmin();

      allow update: if ((isCustomer() && resource.data.userId == request.auth.uid && resource.data.role == 'customer') ||
                        (isAgency() && resource.data.role == 'agency') ||
                        isAdmin()) &&
                       request.resource.data.keys().hasOnly(['read']);
      allow delete: if isAdmin();
    }

    // Reviews Collection (/reviews/{reviewId})
    match /reviews/{reviewId} {
      allow create: if (isCustomer() && request.resource.data.reviewerId == request.auth.uid && request.resource.data.reviewType == 'user_submitted') ||
                       (isAgency() && request.resource.data.reviewType == 'customer_feedback') ||
                       isAdmin();

      allow read: if (isCustomer() && resource.data.reviewerId == request.auth.uid && resource.data.reviewType == 'user_submitted') ||
                     (isAgency() && (resource.data.reviewType == 'customer_feedback' || resource.data.reviewType == 'user_submitted')) ||
                     isAdmin();

      allow update: if (isAgency() && resource.data.reviewType == 'customer_feedback') ||
                       isAdmin();
      allow delete: if (isAgency() && resource.data.reviewType == 'customer_feedback') ||
                       isAdmin();
    }

    // Default deny for any path not explicitly matched
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
