
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    // Fetches the user document based on the authenticated user's UID
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Checks if the authenticated user has a specific role.
    // Ensures the user document exists and the role field matches.
    function userHasRole(role) {
      let userDoc = getUserDoc();
      return isSignedIn() && userDoc.exists && userDoc.data.role == role;
    }

    function isCustomer() {
      return userHasRole('customer');
    }

    function isAgency() {
      return userHasRole('agency');
    }

    function isAdmin() {
      return userHasRole('admin');
    }

    // Users Collection (/users/{userId})
    match /users/{userId} {
      // Create: Any authenticated user can create their own profile document during registration.
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Read:
      // - Users can read their own profile.
      // - Admins can read any user's profile.
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Update:
      // - Users can update their own profile (e.g., displayName, but not role directly).
      // - Admins can update any user's profile (e.g., to change a role).
      allow update: if isSignedIn() && 
                      ( (request.auth.uid == userId && !('role' in request.resource.data)) || isAdmin() );
                      // Prevents self-role change unless admin

      // Delete: Generally false for users. Admins could delete.
      allow delete: if isAdmin();
    }

    // Bookings Collection (/bookings/{bookingId})
    match /bookings/{bookingId} {
      // Create:
      // - Customers can create their own bookings.
      // - Agencies can create bookings (e.g., on behalf of customers).
      // - Admins can create bookings.
      allow create: if (isCustomer() && request.resource.data.customerId == request.auth.uid) ||
                       isAgency() ||
                       isAdmin();
      // Read:
      // - Customers can read their own bookings.
      // - Agencies can read all bookings.
      // - Admins can read all bookings.
      allow read: if (isCustomer() && resource.data.customerId == request.auth.uid) ||
                     isAgency() ||
                     isAdmin();
      // Update:
      // - Customers can update specific fields of their own bookings if status allows (e.g., cancel a pending one).
      //   (This can be more granular, for now, let's say customers cannot update after creation for simplicity).
      // - Agencies can update any booking (e.g., status, assign vehicle/driver).
      // - Admins can update any booking.
      allow update: if isAgency() || isAdmin();
      // allow update: if (isCustomer() && resource.data.customerId == request.auth.uid && (resource.data.status == 'Pending' || resource.data.status == 'Confirmed')) ||
      //                  isAgency() ||
      //                  isAdmin();


      // Delete:
      // - Agencies can delete bookings.
      // - Admins can delete bookings.
      // - Customers cannot delete.
      allow delete: if isAgency() || isAdmin();
    }

    // Employees Collection (/employees/{employeeId}) - Primarily Agency data
    match /employees/{employeeId} {
      // Create, Read, Update, Delete:
      // - Agencies can manage all employees.
      // - Admins can manage all employees.
      // - Customers have no access.
      allow read, write: if isAgency() || isAdmin();
    }

    // Vehicles Collection (/vehicles/{vehicleId}) - Primarily Agency data
    match /vehicles/{vehicleId} {
      // Create, Read, Update, Delete:
      // - Agencies can manage all vehicles.
      // - Admins can manage all vehicles.
      // - Customers have no access.
      allow read, write: if isAgency() || isAdmin();
    }

    // Notifications Collection (/notifications/{notificationId})
    match /notifications/{notificationId} {
      // Create:
      // - Admins can create any notification.
      // - Agencies might create certain types (e.g., for their customers or internal).
      //   For now, let's say only Admins can create broadly. Specific agency creation can be added.
      allow create: if isAdmin(); // Or (isAdmin() || (isAgency() && request.resource.data.role == 'customer'))

      // Read:
      // - Customers can read notifications targeted to their userId and role 'customer'.
      // - Agencies can read notifications targeted to role 'agency'.
      // - Admins can read all notifications.
      allow read: if (isCustomer() && resource.data.userId == request.auth.uid && resource.data.role == 'customer') ||
                     (isAgency() && resource.data.role == 'agency') || // Assuming no userId for general agency notifications
                     isAdmin();

      // Update: (Primarily for marking as read)
      // - Customers can update their own notifications.
      // - Agencies can update agency-wide notifications.
      // - Admins can update any notification.
      allow update: if ((isCustomer() && resource.data.userId == request.auth.uid && resource.data.role == 'customer') ||
                        (isAgency() && resource.data.role == 'agency') || // Assuming no userId for general agency notifications
                        isAdmin()) &&
                       request.resource.data.keys().hasOnly(['read']); // Only 'read' field can be changed by non-admins

      // Delete:
      // - Admins can delete notifications.
      allow delete: if isAdmin();
    }

    // Reviews Collection (/reviews/{reviewId})
    match /reviews/{reviewId} {
      // Create:
      // - Customers can create 'user_submitted' reviews for themselves.
      // - Agencies can create 'customer_feedback' reviews.
      // - Admins (potentially, for seeding or moderation).
      allow create: if (isCustomer() && request.resource.data.reviewerId == request.auth.uid && request.resource.data.reviewType == 'user_submitted') ||
                       (isAgency() && request.resource.data.reviewType == 'customer_feedback') ||
                       isAdmin(); // Admin for seeding/testing

      // Read:
      // - Customers can read their own 'user_submitted' reviews.
      // - Agencies can read 'customer_feedback' reviews and 'user_submitted' reviews (to see what customers said about their service).
      // - Admins can read all reviews.
      allow read: if (isCustomer() && resource.data.reviewerId == request.auth.uid && resource.data.reviewType == 'user_submitted') ||
                     (isAgency() && (resource.data.reviewType == 'customer_feedback' || resource.data.reviewType == 'user_submitted')) ||
                     isAdmin();

      // Update:
      // - Agencies can update 'customer_feedback' reviews they logged (assuming reviewerId would be agency's UID or staff UID under agency).
      //   For simplicity now, any agency user can update any customer_feedback type.
      // - Admins can update any review (moderation).
      // - Customers generally shouldn't update reviews once submitted, or only within a short window.
      allow update: if (isAgency() && resource.data.reviewType == 'customer_feedback') || 
                       isAdmin();

      // Delete:
      // - Agencies can delete 'customer_feedback' reviews they logged.
      // - Admins can delete any review.
      allow delete: if (isAgency() && resource.data.reviewType == 'customer_feedback') || 
                       isAdmin();
    }
    
    // Default deny for any path not explicitly matched
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

    